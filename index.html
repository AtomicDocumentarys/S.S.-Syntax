<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.S. Syntax | v2</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
    <style>
        :root { --bg: #0e1114; --side: #15191c; --card: #1c2126; --accent: #5865f2; --text: #ffffff; --subtext: #b9bbbe; }
        body { background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; margin: 0; overflow: hidden; display: flex; height: 100vh; }

        /* MENU 1: NAVIGATION SIDEBAR */
        .sidebar { width: 240px; background: var(--side); display: flex; flex-direction: column; border-right: 1px solid #2d3238; transition: 0.3s; z-index: 1000; }
        .sidebar.hidden { margin-left: -240px; }
        .nav-item { padding: 15px 25px; cursor: pointer; color: var(--subtext); border-left: 4px solid transparent; }
        .nav-item:hover, .nav-item.active { background: #24292e; color: #fff; border-left-color: var(--accent); }

        /* MENU 2: TOP HEADER (SERVER CONTROL) */
        .top-nav { height: 60px; background: var(--side); width: 100%; display: flex; align-items: center; justify-content: space-between; padding: 0 20px; border-bottom: 1px solid #2d3238; position: absolute; top: 0; z-index: 999; }
        .hamburger { font-size: 24px; cursor: pointer; color: var(--accent); }

        /* DASHBOARD CONTENT */
        main { flex: 1; padding: 80px 30px 30px; overflow-y: auto; box-sizing: border-box; }
        .view { display: none; max-width: 900px; margin: 0 auto; }
        .view.active { display: block; }

        .card { background: var(--card); border-radius: 12px; padding: 25px; margin-bottom: 20px; border: 1px solid #2d3238; line-height: 1.6; }
        .label { font-size: 12px; font-weight: bold; color: var(--subtext); text-transform: uppercase; display: block; margin-bottom: 10px; }
        
        /* BLACK THEME INPUTS */
        select, input, textarea { width: 100%; background: #000; border: 1px solid #333; color: #fff; padding: 12px; border-radius: 6px; margin-bottom: 15px; font-size: 14px; }
        .btn { background: var(--accent); color: white; border: none; padding: 12px 20px; border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%; }

        #code-editor { height: 350px; border-radius: 6px; border: 1px solid #000; }
        .console { background: #000; color: #0f0; padding: 10px; height: 80px; font-family: monospace; font-size: 12px; overflow-y: auto; margin-top: 5px; }
    </style>
</head>
<body>

    <div class="sidebar hidden" id="mainSidebar">
        <div style="padding: 25px; font-weight: bold; font-size: 20px; color: var(--accent);">S.S. Syntax</div>
        <div class="nav-item active" onclick="switchTab('home')">Home</div>
        <div class="nav-item server-only" onclick="switchTab('commands')" style="display:none">Custom Commands</div>
        <div class="nav-item server-only" onclick="switchTab('database')" style="display:none">Database</div>
        <div class="nav-item" onclick="switchTab('terms')">Terms of Service</div>
        <div class="nav-item" onclick="switchTab('privacy')">Privacy Policy</div>
    </div>

    <div class="top-nav">
        <div class="hamburger" onclick="toggleSidebar()">â˜°</div>
        <select id="guild-select" style="width: auto; margin-bottom: 0;" onchange="onServerSelect()">
            <option value="">Select a Server</option>
        </select>
    </div>

    <main>
        <div id="view-home" class="view active">
            <div class="card">
                <h1>Welcome to the Command Forge</h1>
                <p>S.S. Syntax is a high-performance automation engine for Discord. Unlike basic bots, we provide a full **JavaScript Sandbox** for every command you create.</p>
                <h3>How to begin:</h3>
                <ul>
                    <li>Open the left menu and select a mutual server in the top bar.</li>
                    <li>Head to **Custom Commands** to write your first script.</li>
                    <li>Use the **Database** tab to view persistent storage variables.</li>
                </ul>
            </div>
        </div>

        <div id="view-commands" class="view">
            <div id="editor-ui" style="display:none;">
                <div class="card">
                    <span class="label">Trigger Configuration</span>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="cmd-prefix" placeholder="Prefix (e.g. -)" style="width: 80px;">
                        <input type="text" id="cmd-trigger" placeholder="Trigger Name (e.g. start)">
                    </div>
                    <span class="label">Trigger Type</span>
                    <select id="cmd-type">
                        <option>Command (prefix)</option>
                        <option>Starts with</option>
                        <option>Contains</option>
                        <option>Exact Match</option>
                        <option>Regex</option>
                    </select>

                    <span class="label">Role Requirements</span>
                    <input type="text" placeholder="Role IDs (comma separated)">

                    <span class="label">JavaScript Code</span>
                    <div id="code-editor"></div>
                    <div class="console" id="log-output">Live console ready...</div>
                    <button class="btn" style="margin-top: 20px;" onclick="saveCommand()">DEPLOY TO DISCORD</button>
                </div>
            </div>
            <div id="command-list-ui">
                <button class="btn" onclick="openNewEditor()">+ CREATE NEW COMMAND</button>
                <div id="command-list" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div id="view-database" class="view">
            <div class="card">
                <h2>Server Data Vault</h2>
                <p>This shows all persistent variables saved by your commands using `db.set()`.</p>
                <div id="db-list"></div>
            </div>
        </div>

        <div id="view-terms" class="view"><h1>Terms of Service</h1><iframe src="terms.html" style="width:100%; height:70vh; border:none; border-radius:8px;"></iframe></div>
        <div id="view-privacy" class="view"><h1>Privacy Policy</h1><iframe src="privacy.html" style="width:100%; height:70vh; border:none; border-radius:8px;"></iframe></div>
    </main>

    <script>
        let currentGuildId = null;
        let editor = ace.edit("code-editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/javascript");

        function toggleSidebar() { document.getElementById('mainSidebar').classList.toggle('hidden'); }

        function onServerSelect() {
            currentGuildId = document.getElementById('guild-select').value;
            const items = document.querySelectorAll('.server-only');
            if(currentGuildId) {
                items.forEach(el => el.style.display = 'block');
                loadCommands();
            } else {
                items.forEach(el => el.style.display = 'none');
                switchTab('home');
            }
        }

        function switchTab(t) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('view-' + t).classList.add('active');
            event.target.classList.add('active');
            if(window.innerWidth < 800) toggleSidebar();
            if(t === 'commands') editor.resize();
        }

        async function saveCommand() {
            const command = {
                id: Date.now(),
                prefix: document.getElementById('cmd-prefix').value || "!",
                trigger: document.getElementById('cmd-trigger').value,
                type: document.getElementById('cmd-type').value,
                code: editor.getValue()
            };
            await fetch('/api/save-command', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ guildId: currentGuildId, command })
            });
            alert("Deployed!");
            location.reload();
        }

        async function checkAuth() {
            const token = localStorage.getItem('discord_token');
            if (!token) return;
            const res = await fetch('/api/mutual-servers', { headers: { Authorization: `Bearer ${token}` } });
            const guilds = await res.json();
            const select = document.getElementById('guild-select');
            guilds.forEach(g => { select.innerHTML += `<option value="${g.id}">${g.name}</option>`; });
        }
        
        function openNewEditor() { 
            document.getElementById('command-list-ui').style.display = 'none';
            document.getElementById('editor-ui').style.display = 'block';
            editor.resize();
        }

        window.onload = checkAuth;
    </script>
</body>
</html>
