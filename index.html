<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.S. Syntax | Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
    <style>
        :root { --bg: #0b0e11; --nav: #15191c; --accent: #5865f2; --text: #f0f0f0; --border: #2d3238; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        header { height: 60px; background: var(--nav); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; justify-content: space-between; }
        .wrapper { display: flex; flex-grow: 1; overflow: hidden; }
        nav { width: 240px; background: var(--nav); border-right: 1px solid var(--border); }
        .nav-item { padding: 12px 25px; cursor: pointer; color: #b9bbbe; display: flex; align-items: center; gap: 10px; }
        .nav-item.active { background: #2d3238; color: white; border-left: 3px solid var(--accent); }
        main { flex-grow: 1; padding: 30px; overflow-y: auto; }
        .view { display: none; }
        .view.active { display: block; }
        .card { background: #181d21; border: 1px solid var(--border); border-radius: 8px; padding: 20px; margin-bottom: 20px; }
        #code-editor { height: 400px; border-radius: 5px; margin: 15px 0; border: 1px solid #333; }
        .console { background: #000; color: #0f0; padding: 15px; height: 150px; border-radius: 5px; font-family: monospace; overflow-y: auto; }
        select { background: #1e2327; color: white; padding: 8px; border-radius: 5px; }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: bold; color: var(--accent); font-size: 20px;">S.S. Syntax</div>
        <div style="display:flex; gap:10px;">
            <select id="acc-select"><option>Loading...</option></select>
            <select id="guild-select" onchange="serverChanged()"><option value="">Select Server</option></select>
        </div>
    </header>

    <div class="wrapper">
        <nav>
            <div class="nav-item active" onclick="switchTab('home')">üè† Home</div>
            <div class="nav-item" onclick="switchTab('commands')">üìú Custom Commands</div>
            <div class="nav-item" onclick="switchTab('database')">üóÑÔ∏è Database</div>
            <div class="nav-item" onclick="switchTab('terms')">üìë Terms</div>
            <div class="nav-item" onclick="switchTab('privacy')">üõ°Ô∏è Privacy</div>
        </nav>

        <main>
            <div id="view-home" class="view active">
                <h1>Welcome, <span id="user-name">Guest</span></h1>
                <div class="card">
                    <h3>Live Console Output</h3>
                    <div class="console" id="log-output">Select a server to see logs...</div>
                </div>
            </div>

            <div id="view-commands" class="view">
                <h2>Commands</h2>
                <div id="editor-container" style="display:none;" class="card">
                    <input type="text" id="cmd-name" placeholder="Name" style="width:100%; margin-bottom:10px; padding:10px; background:#000; color:#fff;">
                    <div id="code-editor"></div>
                    <button onclick="saveCommand()" style="padding:10px; background:var(--accent); color:#fff; border:none; border-radius:4px;">Save</button>
                    <button onclick="hideEditor()" style="padding:10px; background:#444; color:#fff; border:none; border-radius:4px;">Cancel</button>
                </div>
                <div id="command-list-container">
                    <button onclick="showEditor()" style="padding:10px; background:var(--accent); color:#fff; border:none; border-radius:4px;">+ New Command</button>
                    <div id="command-list" style="margin-top:20px;"></div>
                </div>
            </div>

            <div id="view-database" class="view"><h2>Database</h2><div class="card" id="db-list">No data yet.</div></div>
            <div id="view-terms" class="view"><h2>Terms</h2><p>Standard terms apply.</p></div>
            <div id="view-privacy" class="view"><h2>Privacy</h2><p>We respect your data.</p></div>
        </main>
    </div>

    <script>
        let currentGuildId = null;
        let editor = ace.edit("code-editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/javascript");

        function switchTab(t) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            document.getElementById('view-' + t).classList.add('active');
            event.currentTarget.classList.add('active');
            if(t === 'commands') editor.resize();
        }

        async function serverChanged() {
            currentGuildId = document.getElementById('guild-select').value;
            if(!currentGuildId) return;
            loadCommands();
        }

        // POLLING: Check for new logs every 2 seconds
        setInterval(async () => {
            if (!currentGuildId) return;
            const res = await fetch(`/api/logs/${currentGuildId}`);
            const logs = await res.json();
            const logBox = document.getElementById('log-output');
            logBox.innerHTML = logs.map(l => `<div>[${l.timestamp}] ${l.message}</div>`).join('');
            logBox.scrollTop = logBox.scrollHeight;
        }, 2000);

        async function loadCommands() {
            const res = await fetch(`/api/commands/${currentGuildId}`);
            const cmds = await res.json();
            document.getElementById('command-list').innerHTML = cmds.map(c => `
                <div class="card" style="display:flex; justify-content:space-between; align-items:center;">
                    <span>!${c.name}</span>
                    <button onclick='editCommand(${JSON.stringify(c)})' style="padding:5px 10px;">Edit</button>
                </div>
            `).join('');
        }

        function showEditor() { document.getElementById('editor-container').style.display='block'; document.getElementById('command-list-container').style.display='none'; editor.resize(); }
        function hideEditor() { document.getElementById('editor-container').style.display='none'; document.getElementById('command-list-container').style.display='block'; }

        function editCommand(c) {
            document.getElementById('cmd-name').value = c.name;
            editor.setValue(c.code, -1);
            showEditor();
        }

        async function saveCommand() {
            await fetch('/api/save-command', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ guildId: currentGuildId, command: { id: Date.now(), name: document.getElementById('cmd-name').value, code: editor.getValue() }})
            });
            alert("Saved!");
            hideEditor();
            loadCommands();
        }

        async function checkAuth() {
            const token = localStorage.getItem('discord_token');
            if (!token) return window.location.href = `https://discord.com/api/oauth2/authorize?client_id=1466792124686008341&redirect_uri=${encodeURIComponent(window.location.origin + '/callback.html')}&response_type=code&scope=identify+guilds`;
            
            const userRes = await fetch('https://discord.com/api/users/@me', { headers: { Authorization: `Bearer ${token}` } });
            const user = await userRes.json();
            document.getElementById('user-name').innerText = user.username;
            document.getElementById('acc-select').innerHTML = `<option>${user.username}</option>`;

            const guildRes = await fetch('https://discord.com/api/users/@me/guilds', { headers: { Authorization: `Bearer ${token}` } });
            const guilds = await guildRes.json();
            const select = document.getElementById('guild-select');
            guilds.filter(g => (BigInt(g.permissions) & 0x8n)).forEach(g => {
                select.innerHTML += `<option value="${g.id}">${g.name}</option>`;
            });
        }
        window.onload = checkAuth;
    </script>
</body>
</html>
