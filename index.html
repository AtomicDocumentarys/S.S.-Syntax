<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>S.S. Syntax | Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
    <style>
        :root { --bg: #0b0e11; --nav: #15191c; --card: #1e2327; --accent: #3ba55c; --text: #f0f0f0; --border: #2d3238; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }

        /* HEADER & MENU BUTTON */
        header { background: var(--nav); height: 60px; display: flex; align-items: center; padding: 0 15px; border-bottom: 1px solid #000; justify-content: space-between; z-index: 1001; }
        .menu-btn { background: #2d3238; border: none; color: white; padding: 10px 15px; border-radius: 4px; cursor: pointer; font-size: 18px; display: flex; align-items: center; gap: 8px; }

        /* SIDEBAR (TRANSFORM: -100% is ALWAYS CLOSED INITIALLY) */
        nav { position: fixed; top: 60px; left: -100%; width: 100%; height: calc(100% - 60px); background: var(--nav); transition: 0.3s ease; z-index: 1000; overflow-y: auto; }
        nav.open { left: 0; }

        .sidebar-section { padding: 20px; border-bottom: 1px solid var(--border); }
        .label { display: block; font-size: 11px; color: #72767d; font-weight: bold; margin-bottom: 8px; text-transform: uppercase; }

        /* BLACK CUSTOM BUTTONS/DROPDOWNS */
        .custom-input, .custom-select { width: 100%; background: #000; color: #fff; border: 1px solid #444; padding: 12px; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box; appearance: none; }
        .nav-link { padding: 15px 25px; color: #b9bbbe; cursor: pointer; border-bottom: 1px solid #1a1d21; }
        .nav-link:active { background: var(--accent); color: white; }

        main { flex: 1; overflow-y: auto; padding: 15px; box-sizing: border-box; padding-top: 20px; }
        .view { display: none; width: 100%; }
        .view.active { display: block; }

        .card { background: var(--card); border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        #code-editor { height: 300px; border: 1px solid #000; border-radius: 4px; margin-bottom: 10px; }
        .console { background: #000; color: #0f0; padding: 10px; height: 100px; overflow-y: auto; font-family: monospace; font-size: 11px; border: 1px solid #333; }

        .btn { padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 5px; }
        .btn-green { background: var(--accent); color: white; }
        .btn-red { background: #d83c3e; color: white; }

        iframe { width: 100%; height: 80vh; border: none; background: white; border-radius: 8px; }
    </style>
</head>
<body>

    <header>
        <div style="font-weight: bold; letter-spacing: 1px;">S.S. SYNTAX</div>
        <button class="menu-btn" onclick="toggleMenu()">â˜° MENU</button>
    </header>

    <nav id="sidebar">
        <div class="sidebar-section">
            <span class="label">User Account</span>
            <div id="acc-name" class="custom-input" style="background:#111;">Syncing...</div>
            
            <span class="label">Control Server</span>
            <select id="guild-select" class="custom-select" onchange="serverChanged()">
                <option value="">-- Select mutual server --</option>
            </select>
        </div>
        <div class="nav-link" onclick="switchTab('home')">Home</div>
        <div class="nav-link" onclick="switchTab('commands')">Custom Commands</div>
        <div class="nav-link" onclick="switchTab('database')">Database Management</div>
        <div class="nav-link" onclick="switchTab('terms')">Terms of Service</div>
        <div class="nav-link" onclick="switchTab('privacy')">Privacy Policy</div>
    </nav>

    <main>
        <div id="view-home" class="view active">
            <div class="card"><h1>Dashboard</h1><p>Open menu to select a server.</p></div>
        </div>

        <div id="view-commands" class="view">
            <div id="list-mode">
                <button class="btn btn-green" onclick="openEditor()">+ CREATE NEW COMMAND</button>
                <div id="command-list" style="margin-top:15px;"></div>
            </div>
            <div id="edit-mode" style="display:none;">
                <div class="card">
                    <span class="label">Trigger Type</span>
                    <select id="cmd-type" class="custom-select"><option>Command (prefix)</option></select>
                    <span class="label">Trigger Name</span>
                    <input type="text" id="cmd-trigger" class="custom-input" placeholder="e.g. balance">
                    <span class="label">Code (Use db.set, db.get)</span>
                    <div id="code-editor"></div>
                    <div class="console" id="log-output">Console ready.</div>
                    <button class="btn btn-green" onclick="saveCommand()">SAVE COMMAND</button>
                    <button class="btn btn-red" onclick="closeEditor()">CANCEL</button>
                </div>
            </div>
        </div>

        <div id="view-database" class="view">
            <h2>Database Viewer</h2>
            <div id="db-content"></div>
        </div>

        <div id="view-terms" class="view"><iframe src="terms.html"></iframe></div>
        <div id="view-privacy" class="view"><iframe src="privacy.html"></iframe></div>
    </main>

    <script>
        let currentGuildId = null;
        let editor = ace.edit("code-editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/javascript");

        function toggleMenu() { document.getElementById('sidebar').classList.toggle('open'); }

        function switchTab(t) {
            if(!currentGuildId && (t==='commands' || t==='database')) return alert("Select server first!");
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('view-' + t).classList.add('active');
            if(t === 'database') loadDatabase();
            toggleMenu(); 
        }

        async function serverChanged() {
            currentGuildId = document.getElementById('guild-select').value;
            if(currentGuildId) loadCommands();
        }

        async function loadDatabase() {
            const res = await fetch(`/api/db-all/${currentGuildId}`);
            const data = await res.json();
            const container = document.getElementById('db-content');
            container.innerHTML = Object.entries(data).map(([k, v]) => `
                <div class="card" style="display:flex; justify-content:space-between;">
                    <span><b>${k}</b>: ${v}</span>
                    <button onclick="deleteDb('${k}')" style="color:red; background:none; border:none;">DEL</button>
                </div>
            `).join('') || '<p>No data stored.</p>';
        }

        async function deleteDb(key) {
            await fetch('/api/db-delete', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ guildId: currentGuildId, key })
            });
            loadDatabase();
        }

        function openEditor() { 
            document.getElementById('list-mode').style.display='none'; 
            document.getElementById('edit-mode').style.display='block'; 
            editor.resize(); 
        }
        function closeEditor() { 
            document.getElementById('list-mode').style.display='block'; 
            document.getElementById('edit-mode').style.display='none'; 
        }

        async function saveCommand() {
            const command = {
                id: Date.now(),
                trigger: document.getElementById('cmd-trigger').value,
                code: editor.getValue()
            };
            await fetch('/api/save-command', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ guildId: currentGuildId, command })
            });
            closeEditor();
            loadCommands();
        }

        async function loadCommands() {
            const res = await fetch(`/api/commands/${currentGuildId}`);
            const cmds = await res.json();
            document.getElementById('command-list').innerHTML = cmds.map(c => `
                <div class="card" onclick='editExisting(${JSON.stringify(c)})'>!${c.trigger} (Tap to edit)</div>
            `).join('');
        }

        function editExisting(c) {
            document.getElementById('cmd-trigger').value = c.trigger;
            editor.setValue(c.code, -1);
            openEditor();
        }

        async function checkAuth() {
            const token = localStorage.getItem('discord_token');
            if (!token) return;
            const res = await fetch('/api/mutual-servers', { headers: { Authorization: `Bearer ${token}` } });
            const guilds = await res.json();
            const select = document.getElementById('guild-select');
            guilds.forEach(g => { select.innerHTML += `<option value="${g.id}">${g.name}</option>`; });
            document.getElementById('acc-name').innerText = "Account Connected";
        }

        // Live Log Polling
        setInterval(async () => {
            if (!currentGuildId || document.getElementById('edit-mode').style.display === 'none') return;
            const res = await fetch(`/api/logs/${currentGuildId}`);
            const logs = await res.json();
            document.getElementById('log-output').innerHTML = logs.map(l => `<div>[${l.timestamp}] ${l.message}</div>`).join('');
        }, 2000);

        window.onload = checkAuth;
    </script>
</body>
</html>
