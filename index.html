<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.S. Syntax | Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Mobile-Responsive Fixes */
        :root {
            --bg: #0a192f;
            --card: #112240;
            --primary: #64ffda;
            --text: #e6f1ff;
        }
        body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 15px; }
        .container { max-width: 900px; margin: auto; }
        .hidden { display: none !important; }
        
        header { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid #233554; }
        .logo { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        
        .server-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 20px; }
        .server-card { background: var(--card); padding: 15px; border-radius: 10px; text-align: center; cursor: pointer; transition: 0.3s; border: 1px solid transparent; }
        .server-card:hover { border-color: var(--primary); transform: translateY(-5px); }
        .server-card img { width: 60px; height: 60px; border-radius: 50%; margin-bottom: 10px; }

        .form-card { background: var(--card); padding: 25px; border-radius: 12px; margin-top: 20px; }
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; color: var(--primary); font-size: 0.9rem; }
        input, select, textarea { width: 100%; padding: 12px; background: #020c1b; border: 1px solid #233554; color: white; border-radius: 6px; box-sizing: border-box; }
        textarea { height: 200px; font-family: 'Fira Code', monospace; font-size: 14px; }
        
        .btn-deploy { background: var(--primary); color: var(--bg); border: none; padding: 15px; width: 100%; font-weight: bold; border-radius: 6px; cursor: pointer; margin-top: 10px; }
        .btn-back { background: transparent; border: 1px solid var(--primary); color: var(--primary); padding: 8px 15px; border-radius: 5px; cursor: pointer; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">S.S. Syntax</div>
            <div id="auth-zone">
                <button class="btn-deploy" onclick="login()" style="width: auto; padding: 10px 20px;">Login with Discord</button>
            </div>
        </header>

        <main>
            <section id="view-servers" class="hidden">
                <h2 style="margin-top: 30px;">Choose a Server</h2>
                <div id="serverGrid" class="server-grid"></div>
            </section>

            <section id="view-builder" class="hidden">
                <button class="btn-back" onclick="showServers()">‚Üê Back to Servers</button>
                <h2 id="currentServerName">Command Builder</h2>
                
                <div class="form-card">
                    <div class="form-group">
                        <label>Command Name (No spaces)</label>
                        <input type="text" id="cmdName" placeholder="hello">
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div class="form-group">
                            <label>Trigger Type</label>
                            <select id="cmdType">
                                <option value="prefix">Prefix (!command)</option>
                                <option value="message">Keyword (Inside message)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Language</label>
                            <select id="cmdLang" onchange="applyTemplate()">
                                <option value="js">JavaScript (Node.js)</option>
                                <option value="py">Python 3</option>
                                <option value="go">Go (Golang)</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Trigger / Prefix</label>
                        <input type="text" id="cmdTrigger" value="!">
                    </div>

                    <div class="form-group">
                        <label>Code Output</label>
                        <textarea id="cmdCode" spellcheck="false"></textarea>
                    </div>

                    <button class="btn-deploy" onclick="saveToCloud()">DEPLOY TO DISCORD</button>
                </div>
            </section>
        </main>
    </div>

    <script>
        const CLIENT_ID = "1466792124686008341";
        const REDIRECT_URI = "https://official-sssyntax-website-production.up.railway.app/callback.html";
        let selectedGuildId = null;

        // 1. AUTHENTICATION
        function login() {
            const url = `https://discord.com/oauth2/authorize?client_id=${CLIENT_ID}&response_type=code&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=identify+guilds`;
            window.location.href = url;
        }

        function checkAuth() {
            const token = localStorage.getItem('discord_token');
            if (token) {
                document.getElementById('auth-zone').innerHTML = `<button class="btn-back" onclick="logout()">Logout</button>`;
                loadServers(token);
            }
        }

        function logout() {
            localStorage.removeItem('discord_token');
            window.location.reload();
        }

        // 2. SERVER MANAGEMENT
        async function loadServers(token) {
            try {
                const response = await fetch('https://discord.com/api/users/@me/guilds', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const guilds = await response.json();
                
                const grid = document.getElementById('serverGrid');
                grid.innerHTML = '';

                guilds.forEach(guild => {
                    // Check for MANAGE_GUILD (0x20) or ADMINISTRATOR (0x8)
                    const perms = BigInt(guild.permissions);
                    if ((perms & 0x8n) === 0x8n || (perms & 0x20n) === 0x20n) {
                        const card = document.createElement('div');
                        card.className = 'server-card';
                        const icon = guild.icon ? `https://cdn.discordapp.com/icons/${guild.id}/${guild.icon}.png` : 'https://cdn.discordapp.com/embed/avatars/0.png';
                        card.innerHTML = `
                            <img src="${icon}" alt="${guild.name}">
                            <div style="font-weight:bold; font-size: 0.8rem;">${guild.name}</div>
                        `;
                        card.onclick = () => openBuilder(guild.id, guild.name);
                        grid.appendChild(card);
                    }
                });
                showServers();
            } catch (err) {
                console.error("Failed to load servers", err);
                logout();
            }
        }

        // 3. UI SWITCHING
        function showServers() {
            document.getElementById('view-servers').classList.remove('hidden');
            document.getElementById('view-builder').classList.add('hidden');
        }

        function openBuilder(id, name) {
            selectedGuildId = id;
            document.getElementById('currentServerName').innerText = `Editing: ${name}`;
            document.getElementById('view-servers').classList.add('hidden');
            document.getElementById('view-builder').classList.remove('hidden');
            applyTemplate();
        }

        // 4. CODE TEMPLATES
        const templates = {
            js: '// Node.js Environment\nreturn `Hello ${context.user}! You said: ${context.content}`;',
            py: '# Python 3 Environment\nprint(f"Hello {context[\'user\']}, from Python!")',
            go: '// Go Environment (Main body only)\nfmt.Printf("Hello %s from Go!", context["user"])'
        };

        function applyTemplate() {
            const lang = document.getElementById('cmdLang').value;
            const codeArea = document.getElementById('cmdCode');
            if (!codeArea.value || Object.values(templates).includes(codeArea.value)) {
                codeArea.value = templates[lang];
            }
        }

        // 5. SAVE TO RAILWAY
        async function saveToCloud() {
            const command = {
                id: 'cmd_' + Date.now(),
                name: document.getElementById('cmdName').value.trim().toLowerCase(),
                type: document.getElementById('cmdType').value,
                trigger: document.getElementById('cmdTrigger').value,
                language: document.getElementById('cmdLang').value,
                code: document.getElementById('cmdCode').value
            };

            if (!command.name) return alert("Please enter a command name!");

            try {
                const res = await fetch('/api/save-command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ guildId: selectedGuildId, command })
                });

                if (res.ok) alert("üöÄ Command Deployed Successfully!");
                else alert("‚ùå Deployment Failed.");
            } catch (err) {
                alert("Error connecting to server.");
            }
        }

        // Start
        window.onload = checkAuth;
    </script>
</body>
                                                                                      </html>
    
