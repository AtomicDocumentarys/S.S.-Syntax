<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S.S. Syntax | Pro Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.2/ace.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        :root { 
            --bg: #0f1215; 
            --side: #16191c; 
            --main: #1c2024; 
            --blurple: #5865f2; 
            --success: #3ba55c; 
            --danger: #ed4245; 
            --transition: 0.3s ease;
        }

        body { 
            background: var(--bg); 
            color: white; 
            font-family: 'Inter', sans-serif; 
            margin: 0; 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        /* SIDEBAR LOGIC */
        .sidebar { 
            width: 280px; 
            min-width: 280px;
            background: var(--side); 
            padding: 20px; 
            border-right: 1px solid #2d3238; 
            transition: margin-left var(--transition);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Class to hide sidebar */
        .sidebar.collapsed {
            margin-left: -280px;
        }

        .content { 
            flex-grow: 1; 
            padding: 30px; 
            overflow-y: auto; 
            background: var(--main); 
            transition: width var(--transition);
        }

        /* TOGGLE BUTTON STYLE */
        .toggle-btn {
            position: fixed;
            left: 20px;
            bottom: 20px;
            z-index: 100;
            background: var(--blurple);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* UI ELEMENTS */
        .card { background: #23282d; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        .btn { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.3s; }
        .btn-primary { background: var(--blurple); color: white; }
        
        #console-container { display: none; margin-top: 20px; }
        .console { background: #000; color: #00ff00; font-family: 'Fira Code', monospace; padding: 15px; height: 180px; overflow-y: auto; border-radius: 8px; border: 1px solid #333; font-size: 13px; }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid #111; padding-bottom: 2px; }

        #code-editor { height: 450px; border-radius: 8px; margin: 15px 0; border: 1px solid #333; }
        
        .server-btn { 
            width: 100%; 
            padding: 12px; 
            margin-bottom: 5px; 
            background: transparent; 
            color: #b9bbbe; 
            border: none; 
            text-align: left; 
            cursor: pointer; 
            border-radius: 6px;
        }
        .server-btn:hover { background: #2d3136; color: white; }
    </style>
</head>
<body>

    <button class="toggle-btn" onclick="toggleSidebar()" title="Toggle Menu">☰</button>

    <div class="sidebar" id="main-sidebar">
        <h2 style="color: var(--blurple); margin-bottom: 30px;">S.S. Syntax</h2>
        <div id="server-list" style="flex-grow: 1; overflow-y: auto;">
            </div>
        <button class="btn btn-primary" onclick="login()">Login</button>
    </div>

    <div class="content">
        <div id="view-manage" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h1 id="server-name">Dashboard</h1>
                <div>
                    <input type="checkbox" id="toggle-console" onchange="toggleConsole()">
                    <label for="toggle-console">Live Console</label>
                </div>
            </div>

            <div id="console-container">
                <div class="console" id="log-output">
                    <div class="log-entry">System: Console Ready.</div>
                </div>
            </div>

            <div class="card" style="margin-top: 20px;">
                <button class="btn btn-primary" onclick="showEditor()">+ Create New Command</button>
                <div id="command-list" style="margin-top: 20px;"></div>
            </div>
        </div>

        <div id="view-editor" style="display: none;">
            <button class="btn" onclick="showManager()" style="background: #333; color: white; margin-bottom: 15px;">← Back to Manager</button>
            <div class="card">
                <h3 id="editor-title">Command Workspace</h3>
                <input type="text" id="edit-name" placeholder="Enter command name (e.g. ping)" style="width:100%; padding:12px; margin-bottom:10px; background:#111; color:white; border:1px solid #444; border-radius: 6px;">
                
                <div id="code-editor"></div>
                
                <button class="btn btn-primary" onclick="saveCommand()" style="width: 100%;">DEPLOY COMMAND</button>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let currentGuildId = null;
        let editingCmdId = null;
        
        // --- ACE EDITOR SETUP ---
        let editor = ace.edit("code-editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/javascript");
        editor.setOptions({ fontSize: "16px", showPrintMargin: false });

        // --- SIDEBAR TOGGLE LOGIC ---
        function toggleSidebar() {
            const sidebar = document.getElementById('main-sidebar');
            sidebar.classList.toggle('collapsed');
            
            // Resize the editor after the transition finishes to prevent layout bugs
            setTimeout(() => {
                editor.resize();
            }, 350);
        }

        // --- CONSOLE LOGIC ---
        function toggleConsole() {
            const isChecked = document.getElementById('toggle-console').checked;
            document.getElementById('console-container').style.display = isChecked ? 'block' : 'none';
        }

        socket.on('log', (data) => {
            const output = document.getElementById('log-output');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="timestamp">[${data.timestamp}]</span> ${data.message}`;
            output.appendChild(entry);
            output.scrollTop = output.scrollHeight;
        });

        // --- VIEW SWITCHING ---
        function showEditor() {
            document.getElementById('view-manage').style.display = 'none';
            document.getElementById('view-editor').style.display = 'block';
            editor.resize();
        }

        function showManager() {
            document.getElementById('view-manage').style.display = 'block';
            document.getElementById('view-editor').style.display = 'none';
        }

        // --- DATA LOGIC ---
        async function selectServer(id, name) {
            currentGuildId = id;
            socket.emit('join-server', id);
            document.getElementById('view-manage').style.display = 'block';
            document.getElementById('view-home').style.display = 'none';
            document.getElementById('server-name').innerText = name;
            loadCommands();
        }

        async function loadCommands() {
            const res = await fetch(`/api/commands/${currentGuildId}`);
            const cmds = await res.json();
            const list = document.getElementById('command-list');
            list.innerHTML = cmds.map(c => `
                <div style="background:#1a1d21; padding:15px; margin-bottom:8px; border-radius:8px; display:flex; justify-content:space-between; align-items:center; border: 1px solid #333;">
                    <span><strong>!${c.name}</strong></span>
                    <button class="btn btn-primary" style="padding:8px 15px; font-size: 12px;" onclick='editCommand(${JSON.stringify(c)})'>EDIT</button>
                </div>
            `).join('');
        }

        function editCommand(cmd) {
            editingCmdId = cmd.id;
            document.getElementById('edit-name').value = cmd.name;
            editor.setValue(cmd.code, -1);
            showEditor();
        }

        async function saveCommand() {
            const code = editor.getValue();
            const name = document.getElementById('edit-name').value;
            if(!name) return alert("Enter a name!");

            await fetch('/api/save-command', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ guildId: currentGuildId, command: { id: editingCmdId || 'cmd_'+Date.now(), name, language: 'js', code }})
            });

            alert("Command Saved!");
            showManager();
            loadCommands();
        }

        function login() { 
            window.location.href = `https://discord.com/api/oauth2/authorize?client_id=1466792124686008341&redirect_uri=${encodeURIComponent(window.location.origin + '/callback.html')}&response_type=code&scope=identify+guilds`; 
        }

        async function checkAuth() {
            const token = localStorage.getItem('discord_token');
            if (!token) return;
            const res = await fetch('https://discord.com/api/users/@me/guilds', { headers: { Authorization: `Bearer ${token}` } });
            const guilds = await res.json();
            const list = document.getElementById('server-list');
            list.innerHTML = '';
            guilds.forEach(g => {
                if ((BigInt(g.permissions) & 0x8n) === 0x8n) {
                    list.innerHTML += `<button class="server-btn" onclick="selectServer('${g.id}', '${g.name}')"># ${g.name}</button>`;
                }
            });
        }
        window.onload = checkAuth;
    </script>
</body>
            </html>
            
